<html>

<head>
  <style type="text/css">
    body {
      background-color: #000;
      color: #fff;
    }
    button {
      padding: .5rem;
      margin: .5rem;
      background-color: #333;
      border: 0;
      color: #fff;
    }

  </style>
  <script src="//cdnjs.cloudflare.com/ajax/libs/ace/1.4.1/ace.js"></script>
  <script src="//cdnjs.cloudflare.com/ajax/libs/ace/1.4.1/mode-json.js"></script>
  <script>
    let prom = import('./bmap.js')

    let examples = {
      'hagbard_MAP': ['34ba78755c4db1179029537a2b0189aac75a8ac0c6c99f30fec06c60aa71b183'],
      'symre_HAIP': ['3682dd4c0fc3346b21882e4669b6585733705bacdfb48d2166dff92338093468'],
      'symre_old': ['de6e22a88a7739325793941c53eab6c39b8f817e15f4e305ea6a084040f271f9'],
      'bad_AIP': ["added2539ef771353b226a2e262f0c0b0ff4305bd9dfe81f900868d4297882d3"],
      'metanaria': ['4410068e7582c79da06adc5d6ff32d2845b6e9c002f566f1ebf8b09bbb4d68ca', '3252152dd6b1d3a02030a968664e9c465a7934ef72d54923b55ef6e460196e43', '08078b86273342b2ced4983dc1a8992ddeac165d9b69d72b002a3374bf004c11', 'b1c0d7393e4184f7a0b1036d2d83ad5345e7b406fe42174c8ff4021c1004e0b0', '66094e053724980819aa2e1010549a7161c33394c8f86b5e03b979c5b3856297'],
      'META_node_parent_ancestor': ["70bcbe4dc1ff796389e3de4f5f151cff7eb4a172142468a79677c703afd930b9","59f2e83ac0607d44d764b9040aaa8dd8741e6169444739464f97422055ad001c","06ea0de45680b790d25372bc12b52c7e740e3b10f36d8aabd8b8a31e858a79c2"],
      'META_1': ['07790cb21e48fc98296319efed3645c3b43307031ce6748fa1aed929b24f0f89'],
      'META_2': ['0e34cc59e1c80262b1f25a8079dddcd3a47b90d728b5a3a7348b70a7c437b80c'],
      'B_MAP_1': ['a970f70aad77704e55379ef22150c1bfd77232da5701959093d20cbe68fc1327'],
      'B_MAP_2': ['a970f70aad77704e55379ef22150c1bfd77232da5701959093d20cbe68fc1327'],
      'B_MAP_AIP_1': ['cdfe7ae5c91afe4dc3a5db383e0ca948ec3d51dc2954a9d18ca464db7c9d5d3d'],
      'B_MAP_AIP_2': ['1a7cdf318416d81a3546b7b27b5c569d5099300f3cca385d1531c270524aa653'],
      'bitpaste': ['33d963997360d9edb6b056b9c46cbece48637ed6daa6f2ddd2ea4073ce2e8c72'],
      'B_invalid': ['b5f173c090c6fbfc5e1ff6d200baab2d1b968eec6c5ce64536f60c51f2591812'], // too many fields for schema, should throw error
      'B_MAP_AIP_MANY': ["0272e1b230dfe2603a77469037ad04b32661261ec1453261ded793da0ce297f6", "46991bd7b30c136e41626e998fc04fab8830bb0a8fab8ae8410081426c3d6505", "6645b54733bf630597a89540bc336804d297161113a3290e4285c1bb5e54119b", "536dc444770e0841fbf1b7813e6b228d962a240677be8b778100fc01dfb7ae7d", "36b01a3216e3728b929356a5c4ed137ad4093e14b8d0d92d3d4080721c1c2321", "7b9145df4b41dad05569248c1ac0d3cb5483d898eab30abcd30348c131df14a6", "0afee9bf5603fa529a9d2bda06123c5306079fdb7e64d4db3a32fa46d78b510a", "1a7cdf318416d81a3546b7b27b5c569d5099300f3cca385d1531c270524aa653", "000e988b20060a237c024d24cace5974050f446f8d5c355fe2f031256631b814"]
    }

    let currentExample = localStorage.getItem('example')
    if (!currentExample) {
      currentExample = Object.keys(examples)[0]
      localStorage.setItem('example', Object.keys(examples)[0])
    }

    prom.then((bmap) => {
      console.log('bmap', bmap)

      let txs = examples[localStorage.getItem('example')]

      // The query we constructed from step 2.
      let query = {
          "v": 3,
          "q": {
            "find": {
              "tx.h": {
                "$in": txs
              }
            },
            "sort": {
              "blk.i": -1,
              "i": -1
            },
            "limit": 10
          }
        }

        // Turn the query into base64 encoded string.
        let b64 = btoa(JSON.stringify(query))
        // let url = 'https://bob.planaria.network/q/1GgmC7Cg782YtQ6R9QkM58voyWeQJmJJzG/' + b64
        let url = (useMom() ? 'https://mom.planaria.network/q/' : 'https://bob.planaria.network/q/1GgmC7Cg782YtQ6R9QkM58voyWeQJmJJzG/') + b64

        // Attach planaria API KEY as header
        let header = {
          headers: { key: '14yHvrKQEosfAbkoXcEwY6wSvxNKteFbzU' }
        }

        // Fields to display as text
        let textFields = ['_id', 'i', 'mem']

        // Fields to omit
        let ignoredFields = ['tx', 'blk']

        // Make an HTTP request to bmap endpoint
        fetch(url, header).then((r) => {
          return r.json()
        }).then(async (r) => {
          let collection = !useMom() ? r.c : r.metanet
          console.log('collection', collection, useMom(), r.c)
          for (tx of collection) {
            console.log('before transform:', tx)
            let bmapTx
            try {
              bmapTx = await bmap.default.TransformTx(tx)
            } catch (e) {
              console.warn('error', e)
            }

            let txHeading = document.createElement('h4')
            txHeading.innerHTML = bmapTx.tx.h
            document.body.appendChild(txHeading)

            let pre = document.createElement('div')
            for (let [key, value] of Object.entries(bmapTx)) {

              let html
              if (ignoredFields.indexOf(key) !== -1) {
                continue
              }
              if (textFields.indexOf(key) === -1) {
                html = '<b>' + key +'</b><br /><textarea class="editor" style="width:100%; height:200px">' + JSON.stringify(value, null, '\t') + '</textarea><br /><br />'
              } else {
                html = key + ': ' + value + '<br /><br />'
              }
              pre.innerHTML += html
              // pre.innerHTML = ':<br /> ' + JSON.stringify(bmapTx.METANET || {}) + '<br />B:<br /> ' + JSON.stringify(bmapTx.B || {}) + '<br />MAP:<br /> ' + JSON.stringify(bmapTx.MAP || {})  + '<br />AIP:<br /> ' + JSON.stringify(bmapTx.AIP || {}) + '<br />'
              document.body.appendChild(pre)

            }
            console.log('after transform', bmapTx)
            document.body.appendChild(document.createElement('hr'))
          }

            
          let editor
          //  editor.setTheme('ace/theme/idle_fingers')
          let editors = document.querySelectorAll('.editor')
          
          for(let e of editors) {
            editor = ace.edit(e)
            editor.getSession().setMode("ace/mode/json")
            editor.setTheme("ace/theme/mono_industrial")
            editor.setShowPrintMargin(false)
            editor.setOptions({
              maxLines: Infinity,
              minLines: 3,
              tabSize: 2,
              useSoftTabs: true
            })
          }
        })
    })

    document.addEventListener('DOMContentLoaded', () => {
      // Set page title
      document.getElementById('currentExample').innerHTML = currentExample

      for (let key in examples) {
        let button = document.createElement('button')
        button.id = key
        button.innerHTML = key

        button.addEventListener('click', (e) => {
          localStorage.setItem('example', e.target.id)
          document.location.reload()
        })

        document.querySelector('nav').appendChild(button)
      }

      let momToggle = document.querySelector('#momToggle')
      momToggle.addEventListener('click', () => {
        localStorage.setItem('useMom', !useMom())
        updateMomToggle()
        document.location.reload()
      })

      updateMomToggle()
    })

    function updateMomToggle() {
      momToggle.innerHTML = 'Switch to ' + (!useMom() ? 'MOM' : 'BOB')
    }

    function useMom() {
      return localStorage.getItem('useMom') === 'true'
    }

  </script>

</head>
<body>
  <nav id="nav"></nav>
  <button id="momToggle"></button>
  <h1 id="currentExample"></h1>
</body>
</html>